<!-- public/articles.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Articles — NEWS.ULTRA</title>
  <meta name="description" content="All news articles with sorting, category and subcategory filters." />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <style>
    .glass { background: rgba(0,0,0,.72); backdrop-filter: blur(14px); }
    .card  { background: rgba(0,0,0,.48); border: 1px solid rgba(255,255,255,.10); }
    .chip  { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); }
  </style>
</head>

<body class="bg-slate-950 text-slate-100">
<header class="sticky top-0 z-50 border-b border-white/10 glass">
  <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
    <a href="/" class="font-extrabold text-xl tracking-tight">NEWS<span class="text-sky-400">.ULTRA</span></a>
    <nav class="flex items-center gap-2 text-sm text-slate-300">
      <a class="px-3 py-2 rounded-xl hover:bg-white/10" href="/"><i class="bi bi-house"></i> Home</a>
      <a class="px-3 py-2 rounded-xl hover:bg-white/10" href="/rss.xml"><i class="bi bi-rss"></i> RSS</a>
      <a class="px-3 py-2 rounded-xl hover:bg-white/10" href="/sitemap.xml"><i class="bi bi-diagram-3"></i> Sitemap</a>
    </nav>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">
  <section class="card rounded-3xl p-6">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl md:text-3xl font-black">All Articles</h1>
        <p class="mt-1 text-sm text-slate-400">Sort + filter by Category/Subcategory. Total: <span id="total">0</span></p>
      </div>

      <div class="flex flex-wrap gap-2">
        <select id="sort" class="rounded-2xl bg-white/5 border border-white/10 px-4 py-2 text-sm outline-none">
          <option value="latest">latest</option>
          <option value="views">top viewed</option>
          <option value="likes">top liked</option>
          <option value="comments">top commented</option>
        </select>

        <input id="q" class="rounded-2xl bg-white/5 border border-white/10 px-4 py-2 text-sm outline-none" placeholder="Search..." />
        <button id="apply" class="px-4 py-2 rounded-2xl bg-sky-500/25 border border-sky-400/30 hover:bg-sky-500/35 text-sm">
          Apply
        </button>
      </div>
    </div>

    <div class="mt-4 flex flex-wrap gap-2 items-center">
      <input id="category" class="rounded-2xl bg-white/5 border border-white/10 px-4 py-2 text-sm outline-none" placeholder="Category (e.g. Tech)" />
      <input id="subcategory" class="rounded-2xl bg-white/5 border border-white/10 px-4 py-2 text-sm outline-none" placeholder="Subcategory (e.g. AI)" />
      <div class="ml-auto flex items-center gap-2 text-xs text-slate-400">
        <span>Page:</span>
        <button id="prev" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10">Prev</button>
        <span id="page">1</span>
        <button id="next" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10">Next</button>
      </div>
    </div>

    <div id="chips" class="mt-4 flex flex-wrap gap-2"></div>
  </section>

  <section class="mt-6 grid md:grid-cols-2 xl:grid-cols-3 gap-6" id="grid"></section>

  <div id="state" class="mt-6 text-sm text-slate-400"></div>
</main>

<footer class="border-t border-white/10 py-10">
  <div class="max-w-7xl mx-auto px-4 text-sm text-slate-400 flex flex-wrap items-center justify-between gap-3">
    <div>© <span id="y"></span> NEWS.ULTRA</div>
    <div class="flex items-center gap-4">
      <a class="hover:underline" href="/sitemap.xml">Sitemap</a>
      <a class="hover:underline" href="/robots.txt">Robots</a>
      <a class="hover:underline" href="/rss.xml">RSS</a>
    </div>
  </div>
</footer>

<script>
  document.getElementById("y").textContent = new Date().getFullYear();

  const state = { sort:"latest", page:1, limit:12, category:"", subcategory:"", q:"" };

  function fmt(n){ return new Intl.NumberFormat().format(n||0); }
  function esc(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

  function pushQuery(){
    const p = new URLSearchParams();
    p.set("sort", state.sort);
    p.set("page", String(state.page));
    p.set("limit", String(state.limit));
    if(state.category) p.set("category", state.category);
    if(state.subcategory) p.set("subcategory", state.subcategory);
    if(state.q) p.set("q", state.q);
    history.replaceState(null, "", "/articles.html?" + p.toString());
  }

  function readQuery(){
    const p = new URLSearchParams(location.search);
    state.sort = p.get("sort") || "latest";
    state.page = Math.max(parseInt(p.get("page")||"1",10)||1,1);
    state.limit = Math.min(Math.max(parseInt(p.get("limit")||"12",10)||12,1),48);
    state.category = p.get("category") || "";
    state.subcategory = p.get("subcategory") || "";
    state.q = p.get("q") || "";
  }

  function renderChips(){
    const chips = [];
    if(state.sort) chips.push({k:"sort", v:state.sort});
    if(state.category) chips.push({k:"category", v:state.category});
    if(state.subcategory) chips.push({k:"subcategory", v:state.subcategory});
    if(state.q) chips.push({k:"q", v:state.q});
    document.getElementById("chips").innerHTML = chips.map(c => `
      <span class="chip px-3 py-1 rounded-full text-xs text-slate-300">
        ${esc(c.k)}: <b class="text-slate-100">${esc(c.v)}</b>
      </span>
    `).join("");
  }

  function card(a){
    const cover = a.coverUrl ? `<img class="w-full h-44 object-cover rounded-2xl border border-white/10" src="${a.coverUrl}" alt="cover">` : "";
    const meta = `<div class="text-xs text-slate-400 flex flex-wrap gap-2 items-center">
      <span class="px-2 py-1 rounded bg-white/5 border border-white/10">${esc(a.category||"General")}</span>
      ${a.subcategory ? `<span class="px-2 py-1 rounded bg-white/5 border border-white/10">${esc(a.subcategory)}</span>` : ""}
      <span class="ml-auto">${a.publishedAt ? new Date(a.publishedAt).toLocaleString() : ""}</span>
    </div>`;

    const author = `<div class="mt-2 text-sm text-slate-300">
      <span class="text-slate-400">By</span>
      ${a.authorUsername ? `<a class="text-sky-300 hover:underline" href="/profile.html?u=${encodeURIComponent(a.authorUsername)}">${esc(a.authorName||a.authorUsername)}</a>`
                         : `<span>${esc(a.authorName||"Author")}</span>`}
    </div>`;

    const stats = `<div class="mt-4 text-xs text-slate-400 flex items-center gap-4">
      <span><i class="bi bi-eye"></i> ${fmt(a.views)}</span>
      <span><i class="bi bi-heart"></i> ${fmt(a.likes)}</span>
      <span><i class="bi bi-chat-dots"></i> ${fmt(a.commentsCount)}</span>
    </div>`;

    return `<div class="card rounded-3xl p-5 hover:shadow-[0_0_0_1px_rgba(56,189,248,.25)] transition">
      ${meta}
      <h3 class="mt-3 font-extrabold text-lg leading-snug">${esc(a.title)}</h3>
      ${author}
      <p class="mt-2 text-slate-300 text-sm line-clamp-3">${esc(a.excerpt||"")}</p>
      <div class="mt-4">${cover}</div>
      ${stats}
      <div class="mt-5 flex flex-wrap gap-2">
        <a class="px-4 py-2 rounded-xl bg-sky-500/25 border border-sky-400/30 hover:bg-sky-500/35 text-sm"
           href="/article.html?slug=${encodeURIComponent(a.slug)}">Open</a>
        <a class="px-4 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 text-sm"
           href="/a/${encodeURIComponent(a.slug)}" target="_blank" rel="noopener">SEO view</a>
      </div>
    </div>`;
  }

  async function fetchList(){
    const p = new URLSearchParams();
    p.set("sort", state.sort);
    p.set("page", state.page);
    p.set("limit", state.limit);
    if(state.category) p.set("category", state.category);
    if(state.subcategory) p.set("subcategory", state.subcategory);
    if(state.q) p.set("q", state.q);

    const r = await fetch("/api/articles?" + p.toString(), { credentials: "include" });
    return r.json();
  }

  async function render(){
    pushQuery();
    renderChips();

    document.getElementById("state").textContent = "Loading...";
    const data = await fetchList();

    document.getElementById("total").textContent = fmt(data.total || 0);
    document.getElementById("page").textContent = String(state.page);

    const grid = document.getElementById("grid");
    const items = data.items || [];
    grid.innerHTML = items.map(card).join("") || `<div class="text-sm text-slate-400">No results.</div>`;

    document.getElementById("state").textContent = "";
  }

  function syncControls(){
    document.getElementById("sort").value = state.sort;
    document.getElementById("category").value = state.category;
    document.getElementById("subcategory").value = state.subcategory;
    document.getElementById("q").value = state.q;
  }

  document.getElementById("apply").addEventListener("click", async () => {
    state.sort = document.getElementById("sort").value;
    state.category = document.getElementById("category").value.trim();
    state.subcategory = document.getElementById("subcategory").value.trim();
    state.q = document.getElementById("q").value.trim();
    state.page = 1;
    await render();
  });

  document.getElementById("prev").addEventListener("click", async () => {
    if(state.page > 1){ state.page -= 1; await render(); }
  });
  document.getElementById("next").addEventListener("click", async () => {
    state.page += 1; await render();
  });

  readQuery();
  syncControls();
  render().catch(e => {
    document.getElementById("state").textContent = e.message || "Failed";
  });
</script>
</body>
</html>
